import type { RequestHandler } from 'express';
import validator from 'validator';
import nodemailer from 'nodemailer';
import UsersModel from '@/models/user';
import { generateEmailToken } from '@/utils';

export const checkEmailExists: RequestHandler = async (req, res, next) => {
    try {
        const email = req.body.email;

        if (!validator.isEmail(email)) {
            throw new Error('Email æ ¼å¼ä¸æ­£ç¢º');
        }

        const result = await UsersModel.findOne({ email });

        res.send({
            status: true,
            result: {
                isEmailExists: Boolean(result)
            }
        });
    } catch (error) {
        next();
    }
};

export const sendVerificationCode: RequestHandler = async (req, res, next) => {
    try {
        const email = req.body.email;
        const { code, token } = generateEmailToken();

        const user = await UsersModel.findOneAndUpdate(
            {
                email
            },
            {
                verificationToken: token
            },
            {
                new: true
            }
        );

        if (user) {
            const transporter = await getTransporter();

            await transporter.sendMail({
                from: process.env.EMAILER_USER,
                to: email,
                subject: 'Node é©—è­‰ç¢¼',
                html: `<p>ä½¿ç”¨ ${code} åšç‚º Node å¸³æˆ¶å¯†ç¢¼å®‰å…¨æ€§é©—è­‰ç¢¼</p>`
            });
        }

        res.send({
            status: true
        });
    } catch (error) {
        next(error);
    }
};

const getTransporter = async () => {
    const { EMAILER_USER, EMAILER_PASSWORD } = process.env;

    if (!EMAILER_USER || !EMAILER_PASSWORD) {
        throw new Error('Email æœå‹™æœªå•Ÿç”¨');
    }

    const transporter = nodemailer.createTransport({
        service: 'gmail',
        auth: {
            user: EMAILER_USER,
            pass: EMAILER_PASSWORD
        }
    });

    await transporter.verify();

    return transporter;
};

export const sendOrderEmail: RequestHandler = async (req, res, next) => {
    try {
        const orderEmail = req.body.email;
        const orderName = req.body.name;
        const userID = req.user!['_id'] ;
        const { token } = generateEmailToken();
    
        // æŸ¥è©¢ -è¨‚è³¼æ™‚ï¼Œä½¿ç”¨çš„æœƒå“¡ä¿¡ç®± (éè¨‚è³¼äººä¿¡ç®±)
        const user = await UsersModel.findOneAndUpdate(
            {
                "_id" : userID
            },
            {
                verificationToken: token
            },
            {
                new: true
            }
        );

        // æœƒå“¡ã€è¨‚è³¼äººä¿¡ç®±ç›¸åŒ
        if (user && user.email === orderEmail) {
            const transporter = await getTransporter();
            await transporter.sendMail({
                from: process.env.EMAILER_USER,
                to: orderEmail,
                subject: 'ğŸŒ¿ äº«æ¨‚é£¯åº— - è¨‚è³¼æˆåŠŸä¿¡',
                html: `<p>Hi è¦ªæ„›çš„æœƒå“¡ ${user.name}ï¼š</p>
                       <p>æ‚¨å·²è¨‚è³¼æˆåŠŸ!</p>`
            });
            
        }else{
            // æœƒå“¡ã€è¨‚è³¼äººä¿¡ç®±ä¸åŒï¼Œå‰‡å¯„çµ¦è¨‚è³¼äººã€cc æœƒå“¡
            const transporter = await getTransporter();
            await transporter.sendMail({
                from: process.env.EMAILER_USER,
                to: orderEmail,
                cc: user!.email,
                subject: 'ğŸŒ¿ äº«æ¨‚é£¯åº— - è¨‚è³¼æˆåŠŸä¿¡',
                html: `
                <p>Hi è¦ªæ„›çš„æœ‹å‹ ${orderName}ï¼Œæ‚¨å·²è¨‚è³¼æˆåŠŸ!</p>
                <p>æ­¡è¿åŠ å…¥æœƒå“¡!</p>
                `
            });
        }

        res.send({
            status: true
        });
    } catch (error) {
        next(error);
    }
};
